<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weather + Chat App</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#74b9ff;
    --bg2:#0984e3;
    --card-bg: rgba(255,255,255,0.14);
    --muted: rgba(255,255,255,0.85);
    --accent:#00b894;
    --glass-border: rgba(255,255,255,0.12);
    --shadow: 0 8px 30px rgba(2,6,23,0.25);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background: radial-gradient(ellipse at 10% 10%, rgba(255,255,255,0.04), transparent 10%),
                linear-gradient(180deg,var(--bg1),var(--bg2));
    color:var(--muted);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:28px;
  }

  /* Layout container */
  .app {
    width:100%;
    max-width:980px;
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:20px;
    align-items:start;
  }

  /* On small screens: single column */
  @media (max-width:900px){
    .app{ grid-template-columns: 1fr; padding:8px; }
  }

  /* LEFT main pane (weather) */
  .panel {
    background: var(--card-bg);
    border-radius:16px;
    padding:18px;
    box-shadow:var(--shadow);
    backdrop-filter: blur(10px) saturate(120%);
    border:1px solid var(--glass-border);
  }

  .panel h1{
    margin:0 0 12px 0;
    font-size:20px;
    font-weight:700;
    color:white;
    display:flex;
    align-items:center;
    gap:10px;
  }

  /* search row */
  .search-row{
    display:flex;
    gap:10px;
    margin-bottom:12px;
  }
  .search-row input{
    flex:1;
    padding:10px 12px;
    border-radius:10px 0 0 10px;
    border: none;
    outline:none;
    font-size:15px;
  }
  .search-row button{
    padding:10px 14px;
    border-radius:0 10px 10px 0;
    border:none;
    cursor:pointer;
    font-weight:600;
    background:#2d3436;
    color:white;
  }

  .small-row{
    display:flex;
    gap:8px;
    margin-bottom:14px;
    align-items:center;
    flex-wrap:wrap;
  }

  .btn-loc{
    background:var(--accent);
    color:#063;
    border:none;
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
  }

  .btn-chat{
    margin-left:auto;
    background:transparent;
    border:1px solid rgba(255,255,255,0.12);
    color:rgb(138, 138, 204);
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    display:flex;
    gap:8px;
    align-items:center;
  }

  /* Weather card */
  .weather-card{
    margin-top:6px;
    padding:18px;
    border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    display:flex;
    gap:16px;
    align-items:center;
    box-shadow: 0 6px 20px rgba(0,0,0,0.18);
  }

  .weather-emoji{
    font-size:52px;
    line-height:1;
  }

  .weather-info{
    flex:1;
    color:white;
  }
  .weather-info .place{font-weight:700;font-size:18px}
  .weather-info .temp{font-weight:700;font-size:28px;margin-top:6px}
  .weather-stats{margin-top:8px; display:flex; gap:12px; flex-wrap:wrap; color:rgba(255,255,255,0.9); font-size:14px}

  /* Right pane (extra info + chat button) */
  .side {
    display:flex;
    flex-direction:column;
    gap:16px;
    min-width:260px;
  }
  .card-side{
    background:var(--card-bg);
    border-radius:14px;
    padding:14px;
    border:1px solid var(--glass-border);
    box-shadow:var(--shadow);
  }
  .card-side h3{margin:0 0 8px 0;font-size:16px;color:white}

  .meta-row{display:flex;gap:8px;flex-wrap:wrap}

  /* Chat Floating Button (desktop) */
 .chat-fab{
    position:fixed;
    right:20px;
    bottom:20px;
    background:linear-gradient(135deg,#6c5ce7,#00b894);
    color:white;
    border:none;
    padding:14px 16px;
    border-radius:999px;
    box-shadow:0 8px 30px rgba(0,0,0,0.3);
    cursor:pointer;
    display:flex;
    gap:10px;
    align-items:center;
    z-index:999;
  }
  @media (max-width:900px){
    .chat-fab{ right:14px; bottom:14px; padding:12px 14px; }
  }

  /* Chat modal */
  .chat-modal {
  position: fixed;
  right: 20px;
  bottom: 80px;
  width: 360px;
  max-width: 92%;
  height: 520px;
  max-height: 80vh;
  background-color: #394245; /* Solid light blue */
  border-radius: 14px;
  box-shadow: 0 20px 60px rgba(2, 6, 23, 0.45);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  border: 1px solid rgba(255, 255, 255, 0.08);
  z-index: 1000;
  transform-origin: right bottom;
}
  .chat-header{
    padding:12px 14px;
    display:flex;
    align-items:center;
    gap:10px;
    border-bottom:1px solid rgba(255,255,255,0.04);
    background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
  }
  .bot-avatar{
    width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#6c5ce7,#00b894);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:18px;
  }
  .chat-header .title{font-weight:700;color:white}
  .chat-header .sub{font-size:12px;color:rgba(255,255,255,0.7)}

  .chat-close{ margin-left:auto;background:transparent;border:none;color:rgba(255,255,255,0.7); cursor:pointer; font-size:18px}

  .chat-body {
    padding: 14px;
    flex: 1;
    overflow: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background-color: #024e68; /* Solid light blue background */
}


  .msg {
    max-width:78%;
    padding:10px 12px;
    border-radius:12px;
    word-break:break-word;
    line-height:1.35;
    font-size:14px;
  }
  .msg.user{
    align-self:flex-end;
    background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    color:white;
    border-radius:14px 14px 8px 14px;
  }
  .msg.ai{
    align-self:flex-start;
    background: rgba(255,255,255,0.06);
    color:white;
    border-radius:14px 14px 14px 8px;
    display:flex;
    gap:8px;
    align-items:flex-start;
  }
  .ai-avatar{
    width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#ff9f43,#ff6b6b);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:14px;margin-top:2px;
  }

  .typing {
    display:inline-block;
    width:46px;
    text-align:left;
  }
  .dot { height:7px;width:7px;background:white;border-radius:50%;display:inline-block;margin-right:6px;opacity:0.85; animation: blink 1.3s infinite; }
  .dot:nth-child(2){ animation-delay:0.15s }
  .dot:nth-child(3){ animation-delay:0.3s }
  @keyframes blink { 0%{opacity:0.15}50%{opacity:1}100%{opacity:0.15} }

  .chat-input-row{
    display:flex;
    gap:8px;
    padding:10px;
    border-top:1px solid rgba(255,255,255,0.03);
  }
  .chat-input{
    flex:1;
    padding:10px 12px;
    border-radius:10px;
    border:none;
    outline:none;
    background:rgba(255,255,255,0.03);
    color:white;
  }
  .chat-send{
    background:linear-gradient(135deg,#6c5ce7,#00b894);
    color:white;
    border:none;
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    font-weight:700;
  }

  /* small helper */
  .muted { color: rgba(255,255,255,0.8); font-size:13px }
  .center { text-align:center }
  footer.note{ margin-top:12px; font-size:13px; color:rgba(255,255,255,0.6) }

  /* subtle fade in */
  .chat-modal.hidden{ display:none; }
  .chat-modal.open{ animation: pop .18s ease-out; transform:translateY(0) scale(1); }
  @keyframes pop { from { transform:translateY(6px) scale(.98); opacity:0 } to { transform:translateY(0) scale(1); opacity:1 } } 

</style>
</head>
<body>

<div class="app" role="main">

  <!-- LEFT: Weather panel -->
  <div class="panel" aria-labelledby="weather-title">
    <h1 id="weather-title">üå§ Weather & Local Forecast</h1>

    <div class="search-row" role="search">
      <input id="cityInput" type="text" placeholder="Search city (e.g., Mumbai) ‚Äî press Enter or Search" aria-label="City name">
      <button id="searchBtn" type="button" aria-label="Search">Search</button>
    </div>

    <div class="small-row">
      <button class="btn-loc" id="locBtn">üìç My Location</button>
      <div style="margin-left:10px;color:rgba(255,255,255,0.85)">Detected: <span id="detectedName">‚Äî</span></div>
      <button class="btn-chat" id="openChatBtn" title="Open Chat">üí¨ Chat</button>
    </div>

    <div id="weatherCard" class="weather-card" aria-live="polite">
      <div class="weather-emoji" id="wEmoji">üå°Ô∏è</div>
      <div class="weather-info">
        <div class="place" id="placeName">Fetching location...</div>
        <div class="temp" id="tempValue">--¬∞C</div>
        <div class="weather-desc" id="wDesc" style="text-transform:capitalize; margin-top:6px">‚Äî</div>
        <div class="weather-stats" id="wStats">
          <div id="wind">üí® Wind: ‚Äî</div>
          <div id="hum">üíß Humidity: ‚Äî</div>
        </div>
      </div>
    </div>

    <footer class="note">Tip: If the displayed place differs from your town, we show your exact town name from OpenStreetMap while using OpenWeather for weather.</footer>
  </div>

  <!-- RIGHT: Side card -->
  <div class="side">
    <div class="card-side">
      <h3>Quick Info</h3>
      <div class="meta-row">
        <div class="muted">Units: Celsius (¬∞C)</div>
        <div class="muted">Wind: m/s</div>
      </div>
      <p style="margin-top:10px;color:rgba(255,255,255,0.85)">Search any city or tap <strong>My Location</strong> to get weather for your coordinates. Place name is improved using OpenStreetMap reverse geocoding.</p>
    </div>

    <div class="card-side center">
      <h3>Want help?</h3>
      <p class="muted">Tap <strong>Chat</strong> or the floating button to open the assistant.</p>
      <button class="btn-chat" id="openChatBtn2">üí¨ Open Chat</button>
    </div>
  </div>
</div>

<!-- floating chat button -->
<button class="chat-fab" id="fabBtn" aria-label="Open chat">
  <span style="font-size:18px">üí¨</span>
  <div style="text-align:left">
    <div style="font-weight:700">Chat</div>
    <div style="font-size:12px;opacity:0.95">Ask the assistant</div>
  </div>
</button>

<!-- Chat modal (hidden by default) -->
<div class="chat-modal hidden" id="chatModal" role="dialog" aria-modal="true" aria-label="Chatbot">
  <div class="chat-header">
    <div class="bot-avatar">AI</div>
    <div>
      <div class="title">Pocket Assistant</div>
      <div class="sub">I'm a dummy AI ‚Äî try a message üòä</div>
    </div>
    <button class="chat-close" id="closeChatBtn" title="Close chat">‚úï</button>
  </div>

  <div class="chat-body" id="chatBody" aria-live="polite"></div>

  <div class="chat-input-row">
    <input id="chatInput" class="chat-input" placeholder="Type a message and press Enter..." aria-label="Chat message">
    <button id="sendChatBtn" class="chat-send">Send</button>
  </div>
</div>

<script>
/* ========== Configuration ========== */
const API_KEY = ""; // <- replace with your OpenWeatherMap API key 

/* ========== Utilities ========== */
function el(id){ return document.getElementById(id); }
function setText(id, t){ if (el(id)) el(id).textContent = t; }

function getWeatherEmoji(desc){
  const s = (desc||'').toLowerCase();
  if (s.includes('clear')) return '‚òÄÔ∏è';
  if (s.includes('cloud')) return '‚òÅÔ∏è';
  if (s.includes('rain')) return 'üåßÔ∏è';
  if (s.includes('drizzle')) return 'üå¶Ô∏è';
  if (s.includes('snow')) return '‚ùÑÔ∏è';
  if (s.includes('thunder') || s.includes('storm')) return '‚õàÔ∏è';
  if (s.includes('mist') || s.includes('fog') || s.includes('haze')) return 'üå´Ô∏è';
  return 'üå°Ô∏è';
}

/* ========== Weather display logic ========== */
function displayWeather(locationName, data){
  el('wEmoji').textContent = getWeatherEmoji(data.weather?.[0]?.description || '');
  setText('placeName', locationName || data.name || 'Unknown');
  setText('tempValue', (data.main?.temp != null) ? `${Math.round(data.main.temp)}¬∞C` : '--¬∞C');
  setText('wDesc', data.weather?.[0]?.description || '‚Äî');
  setText('wind', `üí® Wind: ${data.wind?.speed ?? '‚Äî'} m/s`);
  setText('hum', `üíß Humidity: ${data.main?.humidity ?? '‚Äî'}%`);
  el('detectedName').textContent = locationName || data.name || '‚Äî';
}

/* fetch weather by coords */
async function fetchWeather(lat, lon, locationName = null){
  try{
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('Weather fetch failed');
    const data = await r.json();
    displayWeather(locationName, data);
  }catch(err){
    setText('placeName','Unable to fetch weather');
    setText('tempValue','--¬∞C');
    setText('wDesc','‚Äî');
    setText('wind','üí® Wind: ‚Äî');
    setText('hum','üíß Humidity: ‚Äî');
    console.error(err);
  }
}

/* fetch weather by city */
async function fetchCityWeather(city){
  try{
    const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${API_KEY}&units=metric`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('City not found');
    const data = await r.json();
    displayWeather(null, data);
  }catch(err){
    setText('placeName','City not found');
    setText('tempValue','--¬∞C');
    setText('wDesc','‚Äî');
    setText('wind','üí® Wind: ‚Äî');
    setText('hum','üíß Humidity: ‚Äî');
    console.error(err);
  }
}

/* Reverse geocode using OpenStreetMap Nominatim */
async function reverseGeocode(lat, lon){
  try{
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
    if(!r.ok) throw new Error('Reverse geocode failed');
    const data = await r.json();
    return data.address.city || data.address.town || data.address.village || data.display_name || null;
  }catch(e){
    return null;
  }
}

/* ========== Chatbot Logic ========== */
const chatModal = el('chatModal');
const chatBody = el('chatBody');
const chatInput = el('chatInput');

function appendUserMessage(txt){
  const div = document.createElement('div');
  div.className = 'msg user';
  div.textContent = txt;
  chatBody.appendChild(div);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function appendAiMessage(txt){
  const div = document.createElement('div');
  div.className = 'msg ai';
  const av = document.createElement('div');
  av.className = 'ai-avatar';
  av.textContent = 'AI';
  div.appendChild(av);
  const msg = document.createElement('div');
  msg.textContent = txt;
  div.appendChild(msg);
  chatBody.appendChild(div);
  chatBody.scrollTop = chatBody.scrollHeight;
}

let typingIndicator;
function showTyping(){
  if(typingIndicator) return;
  typingIndicator = document.createElement('div');
  typingIndicator.className = 'msg ai typing';
  const av = document.createElement('div');
  av.className = 'ai-avatar';
  av.textContent = 'AI';
  typingIndicator.appendChild(av);
  const dots = document.createElement('span');
  dots.className = 'typing';
  dots.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  typingIndicator.appendChild(dots);
  chatBody.appendChild(typingIndicator);
  chatBody.scrollTop = chatBody.scrollHeight;
}
function hideTyping(){
  if(typingIndicator){
    typingIndicator.remove();
    typingIndicator = null;
  }
}

// ========== The important function you requested: sendMessage ==========

async function sendMessage(){
  const txt = chatInput.value.trim();
  if(!txt) return;
  appendUserMessage(txt);
  chatInput.value = '';
  showTyping();

  try {
    const payload = {
      contents: [
        {
          parts: [
            { text: txt }
          ]
        }
      ]
    };

    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-goog-api-key': ''  // <--- Replace with your actual API key
      },
      body: JSON.stringify(payload)
    });

    if(!response.ok){
      throw new Error(`API error: ${response.status} ${response.statusText}`);
    }

    const data = await response.json();

    // Assuming response structure has a candidates array with content
    const reply = data.candidates?.[0]?.content || "Sorry, no reply from AI.";

    hideTyping();
    appendAiMessage(reply);

  } catch(err){
    hideTyping();
    appendAiMessage("Sorry, the chat service is unavailable.");
    console.error(err);
  }
}

/* ========== Event listeners ========== */

// Weather search by city
el('searchBtn').addEventListener('click', () => {
  const city = el('cityInput').value.trim();
  if(city) fetchCityWeather(city);
});

el('cityInput').addEventListener('keydown', (e) => {
  if(e.key === 'Enter'){
    e.preventDefault();
    const city = el('cityInput').value.trim();
    if(city) fetchCityWeather(city);
  }
});

// Get location button
el('locBtn').addEventListener('click', () => {
  if(!navigator.geolocation){
    alert("Geolocation is not supported in your browser");
    return;
  }
  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const name = await reverseGeocode(lat, lon);
    fetchWeather(lat, lon, name);
  }, () => {
    alert("Unable to retrieve your location");
  });
});

// Chat open buttons
el('openChatBtn').addEventListener('click', () => {
  chatModal.classList.remove('hidden');
  chatInput.focus();
});
el('openChatBtn2').addEventListener('click', () => {
  chatModal.classList.remove('hidden');
  chatInput.focus();
});
el('fabBtn').addEventListener('click', () => {
  chatModal.classList.remove('hidden');
  chatInput.focus();
});
el('closeChatBtn').addEventListener('click', () => {
  chatModal.classList.add('hidden');
  chatBody.innerHTML = '';
});

// Chat send button and enter key
el('sendChatBtn').addEventListener('click', sendMessage);
chatInput.addEventListener('keydown', (e) => {
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

/* ========== Initial default ========== */
// Try to fetch weather for a default location (e.g., Mumbai)
fetchCityWeather('Mumbai');
</script>

</body>
</html>

